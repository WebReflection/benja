if [ "${USER}" = "root" ]; then
  echo " $(tput bold)root$(tput sgr0) user $(tput smul)cannot$(tput rmul) setup the system"
  exit 1
fi

# sudo
if [ "$(which sudo 2> /dev/null)" = "" ]; then
  echo " $(tput bold)installing sudo$(tput sgr0)"
  bash <(curl -s https://archibold.io/install/sudo)
fi

echo " $(tput bold)updating system$(tput sgr0)"
sudo pacman -Syu --needed --noconfirm

echo " $(tput bold)installing dependencies$(tput sgr0)"
sudo pacman -S --needed --noconfirm \
  cpupower upower openssh nodejs npm git python2 \
  xorg-server xorg-xinit xorg-xrandr xorg-xset xterm \
  noto-fonts noto-fonts-emoji

echo " $(tput bold)installing Qt$(tput sgr0)"
sudo pacman -S --needed --noconfirm \
  qt5-quickcontrols qt5-webengine

# configure 8080 to 80 redirect
if [ ! -f /etc/systemd/system/localhost-80to8080.service ]; then
  echo " $(tput bold)localhost-80to8080.service$(tput sgr0)"
  echo "[Unit]
Description=localhost 80 to 8080 service

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/bin/iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080
ExecStart=/usr/bin/iptables -t nat -I OUTPUT -p tcp -o lo --dport 80 -j REDIRECT --to-port 8080

[Install]
WantedBy=multi-user.target
" >localhost-80to8080.service
  sudo mv localhost-80to8080.service /etc/systemd/system/localhost-80to8080.service
  sudo systemctl enable localhost-80to8080.service
fi

if [ -f /boot/config.txt ]; then
  cat /boot/config.txt > config.txt
  if [ "$(cat config.txt | grep dispmanx_offline=1)" = "" ]; then
    sudo sed -i -e "s/gpu_mem=.*//" /boot/config.txt
    echo " $(tput bold)/boot/config.txt$(tput sgr0)"
    echo '
gpu_mem=192
dispmanx_offline=1
dtoverlay=vc4-fkms-v3d
dtparam=audio=on
'>>config.txt
    sudo mv config.txt /boot/config.txt
    if [ -f /boot/cmdline.txt ]; then
      sudo sed -i "s/rootwait/rootwait quiet loglevel=0 splash/" /boot/cmdline.txt
    fi
  fi
  rm -rf config.txt
fi

if [ ! -f /etc/systemd/system/application-disk.service ]; then
echo "[Unit]
Description=application ${HOME}/app disk

[Service]
User=root
Type=simple
ExecStart=/usr/bin/mount /dev/mmcblk0p3 ${HOME}/app -o uid=${USER},gid=users,umask=0022

[Install]
WantedBy=multi-user.target
">application-disk.service
  sudo mv application-disk.service /etc/systemd/system/application-disk.service
  mkdir ${HOME}/app
  sync
  sudo systemctl enable application-disk.service
  sudo systemctl start application-disk.service
fi

sudo systemctl enable sshd
sudo systemctl enable dhcpcd

echo " $(tput bold)automatic login$(tput sgr0)"
if [ ! -f /etc/systemd/system/getty@tty1.service.d/override.conf ]; then
  echo 'using override.conf'
  sudo mkdir -p /etc/systemd/system/getty@tty1.service.d
  echo "[Service]
ExecStart=
ExecStart=-/usr/sbin/agetty -nia ${USER} %I
"> override.conf
  sudo mv override.conf /etc/systemd/system/getty@tty1.service.d/
  sync && sleep 1
fi

if [ -f /etc/motd ]; then
  echo " $(tput bold)drop welcome message$(tput sgr0)"
  sudo rm -rf /etc/motd
fi

if [ "$(which yaourt 2> /dev/null)" = "" ]; then
  echo " $(tput bold)installing yaourt$(tput sgr0)"
  bash <(curl -s archibold.io/install/yaourt)

  echo " $(tput bold)installing pigpio$(tput sgr0)"
  yaourt -S --needed --noconfirm python-pigpio-git
  sudo cp /usr/local/lib/libpigpio* /usr/lib/
fi

if [ "$(sudo cat /etc/sudoers | grep $(which npm))" = "" ]; then
  echo "${USER} ALL=NOPASSWD: $(which npm)"> sudoers
  sudo bash -c 'cat sudoers >>/etc/sudoers'
  rm sudoers
fi

if [ ! -d ~/.npm-global ]; then
  mkdir ~/.npm-global
  echo " $(tput bold)nodejs prefix$(tput sgr0)"
  npm config set prefix ~/.npm-global
  echo "npm prefix: $(npm config get prefix)"
  echo "sudo npm prefix: $(sudo npm config get prefix)"
  export NPM_CONFIG_PREFIX=~/.npm-global
  export BIN_PATH=~/.npm-global/bin
  export NODE_PATH=~/.npm-global/lib/node_modules
  export APP_PATH=~/app/node_modules
  echo "
export NPM_CONFIG_PREFIX=${NPM_CONFIG_PREFIX}
export PATH=${BIN_PATH}:\$PATH
export NODE_PATH=${NODE_PATH}
export APP_PATH=${APP_PATH}
">environment
  sudo bash -c 'cat environment>>/etc/environment'
  rm environment
  export PATH=${BIN_PATH}:${PATH}
  echo "NPM_CONFIG_PREFIX=${NPM_CONFIG_PREFIX}"
  echo "PATH=${PATH}"
  echo "NODE_PATH=${APP_PATH}:${NODE_PATH}"
  echo " $(tput bold)npm global modules$(tput sgr0)"
  npm install -g node-gyp node-pre-gyp
  npm install -g raspi-io johnny-five
  npm install -g @webreflection/node-worker
fi

echo " $(tput bold)cleaning up and optimizing$(tput sgr0)"
yaourt -Sc --noconfirm
while [ "$(yaourt -Qdtq)" != "" ]; do
  yaourt -R --noconfirm $(yaourt -Qdtq)
done
sudo pacman-optimize

if [ -f setup-user ]; then
  bash setup-user
fi
