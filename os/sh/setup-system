if [ "${USER}" = "root" ]; then
  echo " $(tput bold)root$(tput sgr0) user $(tput smul)cannot$(tput rmul) setup the system"
  exit 1
fi

# sudo
if [ "$(which sudo 2> /dev/null)" = "" ]; then
  echo " $(tput bold)installing sudo$(tput sgr0)"
  bash <(curl -s https://archibold.io/install/sudo)
fi

echo " $(tput bold)system update + install dependencies$(tput sgr0)"
sudo pacman -Syu --needed --noconfirm \
  weston openssh nodejs npm \
  gjs webkit2gtk gst-plugins-base gst-plugins-good gst-libav \
  libva-mesa-driver libva-vdpau-driver libvdpau-va-gl

echo " $(tput bold)npm prefix + nodejs global modules$(tput sgr0)"
npm config set prefix '~/.npm-packages'
npm install -g node-gyp node-pre-gyp

# weston service
if [ ! -f /etc/systemd/system/weston-compositor.service ]; then
  echo " $(tput bold)weston-compositor.service$(tput sgr0)"
  echo "[Unit]
Description=Weston Compositor
Conflicts=getty@tty1.service
After=getty@tty1.service systemd-user-sessions.service

[Service]
User=${USER}
Restart=always
RestartSec=2
TimeoutSec=2
EnvironmentFile=/etc/environment
ExecStart=/usr/bin/weston-launch
IgnoreSIGPIPE=no
StandardOutput=syslog
StandardError=inherit
StandardInput=tty
TTYPath=/dev/tty1

[Install]
Alias=display-manager.service" > weston-compositor.service
  sudo mv weston-compositor.service /etc/systemd/system
  sudo systemctl enable weston-compositor
fi

# weston-launch
if [ -f /usr/bin/weston-launch ]; then
  echo " $(tput bold)weston-launch$(tput sgr0)"
  sudo groupadd weston-launch
  sudo usermod -aG weston-launch ${USER}
  sudo chown root /usr/bin/weston-launch
  sudo chmod +s /usr/bin/weston-launch
fi

# configure 8080 to 80 redirect
if [ ! -f /etc/systemd/system/localhost-80to8080.service ]; then
  echo " $(tput bold)localhost-80to8080.service$(tput sgr0)"
  echo "[Unit]
Description=localhost 80 to 8080 service

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/bin/iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080
ExecStart=/usr/bin/iptables -t nat -I OUTPUT -p tcp -o lo --dport 80 -j REDIRECT --to-port 8080

[Install]
WantedBy=multi-user.target
" >localhost-80to8080.service
  sudo mv localhost-80to8080.service /etc/systemd/system/localhost-80to8080.service
  sudo systemctl enable localhost-80to8080.service
fi

# configure environment
cat /etc/environment > environment
if [ "$(cat environment | grep GDK_BACKEND)" = "" ]; then
  echo " $(tput bold)/etc/environment$(tput sgr0)"
  echo "
XDG_RUNTIME_DIR=/tmp
XDG_CONFIG_HOME=${HOME}/.config
NODE_PATH=${HOME}/.npm-packages/lib/node_modules
GDK_BACKEND=wayland
CLUTTER_BACKEND=wayland
QT_QPA_PLATFORM=wayland
SDL_VIDEODRIVER=wayland
GTK_THEME='Adwaita:dark'
PATH=$PATH:${HOME}/.npm-packages/bin
" >>environment
  sudo mv environment /etc/environment
fi
rm -rf environment

if [ "$(cat /etc/bash.bashrc | grep npm-packages/bin)" = "" ]; then
  echo " $(tput bold)/etc/bash.bashrc$(tput sgr0)"
echo "
PATH=$PATH:${HOME}/.npm-packages/bin
export PATH
" >bash.bashrc
  cat /etc/bash.bashrc >>bash.bashrc
  sudo mv bash.bashrc /etc/
  rm -rf bash.bashrc
fi

if [ -f /boot/config.txt ]; then
  cat /boot/config.txt > config.txt
  if [ "$(cat config.txt | grep dispmanx_offline=1)" = "" ]; then
    echo " $(tput bold)/boot/config.txt$(tput sgr0)"
    echo '
gpu_mem=128
dispmanx_offline=1
dtoverlay=vc4-fkms-v3d
dtparam=audio=on
'>>config.txt
    sudo mv config.txt /boot/config.txt
    if [ -f /boot/cmdline.txt ]; then
      sudo sed -i "s/rootwait/rootwait quiet loglevel=0 splash/" /boot/cmdline.txt
    fi
  fi
  rm -rf config.txt
fi

if [ ! -f /etc/systemd/system/BOOT2WK-disk.service ]; then
echo "[Unit]
Description=BOOT2WK ${HOME}/app disk

[Service]
User=root
Type=simple
ExecStart=/usr/bin/mount /dev/mmcblk0p3 ${HOME}/app -o uid=${USER},gid=users,umask=0022

[Install]
WantedBy=multi-user.target
">BOOT2WK-disk.service
  sudo mv BOOT2WK-disk.service /etc/systemd/system/BOOT2WK-disk.service
  mkdir ${HOME}/app
  sync
  sudo systemctl enable BOOT2WK-disk.service
  sudo systemctl start BOOT2WK-disk.service
fi

sudo systemctl enable sshd
sudo systemctl enable dhcpcd

if [ -f setup-user ]; then
  bash setup-user
fi