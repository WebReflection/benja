if [ "${USER}" = "root" ]; then
  echo " $(tput bold)root$(tput sgr0) user $(tput smul)cannot$(tput rmul) setup the app"
  exit 1
fi
if [ "$(which npm 2> /dev/null)" = "" ]; then
  echo " please install $(tput bold)setup-system$(tput sgr0) first"
  exit 1
fi

echo " $(tput bold)preparing ${HOME}$(tput sgr0)"
cd ~/
touch .hushlogin
mkdir -p .config
mkdir -p .npm-packages/bin
mkdir -p app/node_modules
mkdir -p app/workers

echo " $(tput bold)~/.app-launcher$(tput sgr0)"
if [ ! -f ~/.app-launcher ]; then
  echo "#!/usr/bin/env bash

if [ -f ~/app/package.json ]; then
  cd ~/app
  if [ ! -d node_modules ]; then
    mkdir node_modules
    npm install --production --no-bin-links
  fi
  npm start
else
  cd ~/
  if [ -f ~/app/package.jsno ]; then
    mv ~/app/package.jsno ~/app/package.json
  elif [ -f ~/app/package.jsoff ]; then
    mv ~/app/package.jsoff ~/app/package.json
  fi
  weston-terminal --fullscreen
fi" >~/.app-launcher
  chmod a+x ~/.app-launcher
fi

echo " $(tput bold)~/.config/weston.ini$(tput sgr0)"
if [ ! -f ~/.config/weston.ini ]; then
  echo "[core]
idle-time=0
require-input=false

[shell]
client=/home/${USER}/.app-launcher
animation=none
close-animation=none
startup-animation=none
locking=false
" >~/.config/weston.ini
fi

echo " $(tput bold)~/app$(tput sgr0)"
cd ~/app
touch reload
if [ ! -f logo-dark.svg ]; then
  curl -LOs "https://benja.andreagiammarchi.now.sh/os/gjs/logo-dark.svg"
fi
if [ ! -f logo-light.svg ]; then
  curl -LOs "https://benja.andreagiammarchi.now.sh/os/gjs/logo-light.svg"
fi
if [ ! -f index.html ]; then
  curl -LOs "https://benja.andreagiammarchi.now.sh/os/gjs/index.html"
fi
if [ ! -f index.js ]; then
  curl -LOs "https://benja.andreagiammarchi.now.sh/os/gjs/index.js"
fi
if [ ! -f package.json ]; then
  curl -LOs "https://benja.andreagiammarchi.now.sh/os/gjs/package.json"
fi
if [ ! -f browse ]; then
  curl -LOs "https://benja.andreagiammarchi.now.sh/os/gjs/browse"
fi
if [ ! -f workers/utils.js ]; then
  cd workers
  curl -LOs "https://benja.andreagiammarchi.now.sh/os/gjs/workers/utils.js"
  cd ..
fi
npm install --production --no-bin-links
